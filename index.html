<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">DNS制限テストツール (IPv4/IPv6/H3対応)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Tailwind gray-100 */
        }
        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem; /* rounded-lg */
            font-weight: 600;
            display: inline-block;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap;
        }
        .success {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
        }
        .failure {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
        }
        .partial {
            background-color: #fef3c7; /* Tailwind yellow-100 */
            color: #92400e; /* Tailwind yellow-800 */
        }
        .pending {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            color: #374151; /* Tailwind gray-700 */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .group-test-btn {
            @apply px-4 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-300;
        }
        .group-test-btn:disabled {
            @apply bg-gray-400 text-gray-700 cursor-not-allowed shadow-none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        <!-- Language Switcher -->
        <div class="flex justify-end mb-4">
            <button id="lang-ja" class="lang-btn px-3 py-1 text-sm rounded-lg bg-blue-100 text-blue-800 font-semibold mr-2" data-lang="ja">日本語</button>
            <button id="lang-en" class="lang-btn px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-700" data-lang="en">English</button>
        </div>
        
        <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4 border-b-2 pb-2">
            <!-- Content set by JS -->
        </h1>
        <p id="descriptionText" class="text-gray-600 mb-8">
            <!-- Content set by JS, with HTML for bold emphasis -->
        </p>

        <!-- DoH Test Section -->
        <section class="mb-8 border border-gray-200 rounded-lg p-4 bg-blue-50">
            <h2 id="dohTitle" class="text-2xl font-semibold text-blue-800 mb-3 flex items-center">
                <!-- Content set by JS -->
            </h2>
            <p id="dohDescription" class="text-gray-600 mb-4">
                <!-- Content set by JS, with HTML for bold emphasis -->
            </p>
            
            <button id="runAllDohTest" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 active:bg-blue-800 mb-4">
                <!-- Content set by JS -->
            </button>

            <!-- Summary and Toggle Section -->
            <div id="summarySection" class="mb-4 p-4 bg-white border border-gray-200 rounded-lg shadow-md">
                <div id="statusSummary" class="flex justify-around text-center mb-3 space-x-2">
                    <!-- Status counts will go here (Updated by JS) -->
                </div>
                <button id="toggleDetailsButton" class="w-full py-2 text-sm font-semibold rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-150">
                    <!-- Text updated by JS -->
                </button>
            </div>

            <!-- Test Results Area (Grouped by Protocol) -->
            <div id="testResultsContainer" class="mt-4 space-y-6">
                <!-- 結果がJavaScriptによってここに挿入される -->
            </div>
            
        </section>

        <!-- Other DNS Methods Explanation -->
        <section class="mb-8 p-4 border border-gray-200 rounded-lg bg-yellow-50">
            <h2 id="otherDnsTitle" class="text-2xl font-semibold text-yellow-800 mb-3 flex items-center">
                <!-- Content set by JS -->
            </h2>
            
            <div class="space-y-4 text-gray-700">
                <p id="dns53Text">
                    <!-- Content set by JS, with <strong> tags -->
                </p>
                <p id="dotText">
                    <!-- Content set by JS, with <strong> tags -->
                </p>
                <p class="p-3 bg-white border border-yellow-200 rounded-md">
                    <strong id="hintTitle" class="text-yellow-700"></strong>
                    <span id="hintContent"></span>
                </p>
            </div>
        </section>

        <footer class="text-center mt-8 pt-4 border-t border-gray-200">
            <p id="footerText" class="text-sm text-gray-500">
                <!-- Content set by JS -->
            </p>
        </footer>
    </div>

    <script type="text/javascript">
        // 言語設定の定数
        const LANGUAGES = {
            ja: {
                appTitle: "DNS制限テストツール (IPv4/IPv6/H3対応)",
                mainTitle: "DNS制限テストツール (IPv4/IPv6/H3対応)",
                // HTMLタグを含むため、そのままの文字列として定義
                descriptionText: "お使いのネットワークで、DNS over HTTPS (DoH) の各種プロトコルが利用可能か、<strong class=\"font-bold text-gray-800\">IPv4とIPv6接続の両方</strong>でテストします。",
                dohTitle: "DNS over HTTPS (DoH) プロトコル別テスト",
                // HTMLタグを含むため、そのままの文字列として定義
                dohDescription: "プロバイダ名が緑色になれば、そのプロバイダの<strong class=\"font-bold text-gray-800\">少なくとも1つのエンドポイントでIPv4/IPv6のいずれかが成功</strong>しています。",
                runAllButton: "全テスト実行 (H2 & H3)",
                otherDnsTitle: "その他のDNS制限について",
                // 既にstrongタグを使用している部分は維持
                dns53Title: "通常のDNS (ポート53):",
                dns53Content: "ブラウザから直接テストすることはできませんが、外部DNSを設定した機器で名前解決を試すことで確認できます。",
                dotTitle: "DNS over TLS (DoT - ポート853):",
                dotContent: "ブラウザのセキュリティ制限により、Webページから直接接続可否をテストすることは技術的に不可能です。",
                hintTitle: "【ヒント】",
                hintContent: "ポート53/853の制限を確認したい場合は、PCやスマートフォンでVPNサービスやカスタムDNS設定を有効にし、ウェブサイトが正常に表示されるか（名前解決ができるか）を確認するのが最も確実な方法です。",
                footerText: "これはクライアント側のJavaScriptテストであり、ネットワークの完全な状態を示すものではありません。",
                status: {
                    pending: "未実行",
                    testing: "テスト中...",
                    available: "成功",
                    unavailable: "失敗",
                    partial: "一部成功",
                    runSingle: "テスト実行",
                    showDetails: "詳細を表示",
                    hideDetails: "詳細を非表示",
                    groupStatusPartial: "一部利用可能",
                    groupStatusTesting: "グループテスト中...",
                    connectionType: {
                        ipv4: "IPv4接続",
                        ipv6: "IPv6接続"
                    },
                    endpointTesting: (type) => `${type}のDoHクエリを送信中`,
                    endpointSuccess: (duration, status) => `接続成功 応答時間: ${duration}ms DNS応答: ${status}`,
                    endpointErrorNetwork: (duration) => `接続失敗 (Network Error) 時間: ${duration}ms`,
                    endpointErrorHttp: (status, duration) => `接続失敗 (HTTP Error: ${status}) 時間: ${duration}ms`,
                    endpointErrorInvalidDns: (status, duration) => `接続失敗 (Invalid DNS Response) HTTP応答: ${status} 時間: ${duration}ms`
                }
            },
            en: {
                appTitle: "DNS Restriction Test Tool (IPv4/IPv6/H3)",
                mainTitle: "DNS Restriction Test Tool (IPv4/IPv6/H3)",
                // HTMLタグを含むため、そのままの文字列として定義
                descriptionText: "Test whether various DNS over HTTPS (DoH) protocols are available on your network for <strong class=\"font-bold text-gray-800\">both IPv4 and IPv6 connectivity</strong>.",
                dohTitle: "DNS over HTTPS (DoH) Protocol Tests",
                // HTMLタグを含むため、そのままの文字列として定義
                dohDescription: "If the provider name is green, <strong class=\"font-bold text-gray-800\">at least one endpoint was successful in either IPv4 or IPv6</strong>.",
                runAllButton: "Run All Tests (H2 & H3)",
                otherDnsTitle: "About Other DNS Restrictions",
                dns53Title: "Traditional DNS (Port 53):",
                dns53Content: "Cannot be tested directly from the browser, but can be checked by trying name resolution on a device configured with external DNS.",
                dotTitle: "DNS over TLS (DoT - Port 853):",
                dotContent: "Directly testing connectivity from a webpage is technically impossible due to browser security restrictions.",
                hintTitle: "【Hint】",
                hintContent: "To check restrictions on ports 53/853, the surest method is to enable a VPN service or custom DNS settings on your PC or smartphone and verify if websites load correctly (if name resolution works).",
                footerText: "This is a client-side JavaScript test and does not represent the full state of the network.",
                status: {
                    pending: "Pending",
                    testing: "Connecting...",
                    available: "Success",
                    unavailable: "Failed",
                    partial: "Partial Success",
                    runSingle: "Run Test",
                    showDetails: "Show Details",
                    hideDetails: "Hide Details",
                    groupStatusPartial: "Partially Available",
                    groupStatusTesting: "Group Testing...",
                    connectionType: {
                        ipv4: "IPv4 Connection",
                        ipv6: "IPv6 Connection"
                    },
                    endpointTesting: (type) => `Sending DoH query for ${type}...`,
                    endpointSuccess: (duration, status) => `Connection successful. Response time: ${duration}ms. DNS response: ${status}`,
                    endpointErrorNetwork: (duration) => `Connection Failed (Network Error). Time: ${duration}ms`,
                    endpointErrorHttp: (status, duration) => `Connection Failed (HTTP Error: ${status}). Time: ${duration}ms`,
                    endpointErrorInvalidDns: (status, duration) => `Connection Failed (Invalid DNS Response). HTTP Status: ${status}. Time: ${duration}ms`
                }
            }
        };

        let currentLang = 'ja';
        // 初期状態は非表示
        let detailsVisible = false; 

        // ベースとなるプロバイダのリスト (ControlDは除外)
        const BASE_PROVIDERS = [
            { id: 'google', name: "Google Public DNS", endpoints: [{ id: 'google_default', url: "https://dns.google/resolve", label: "Default" }] },
            { id: 'cloudflare', name: "Cloudflare DNS", endpoints: [{ id: 'cloudflare_default', url: "https://cloudflare-dns.com/dns-query", label: "Default" }] },
            { id: 'quad9', name: "Quad9 DNS", endpoints: [{ id: 'quad9_default', url: "https://dns.quad9.net/dns-query", label: "Default" }] },
            { id: 'adguard', name: "AdGuard DNS", endpoints: [
                { id: 'adguard_default', url: "https://dns.adguard.com/dns-query", label: "Default" },
                { id: 'adguard_family', url: "https://dns-family.adguard.com/dns-query", label: "Family Protection" }
            ] },
            { id: 'cleanbrowsing', name: "CleanBrowsing", endpoints: [{ id: 'cleanbrowsing_family', url: "https://doh.cleanbrowsing.org/doh/family/", label: "Family" }] },
            { id: 'nextdns', name: "NextDNS", endpoints: [{ id: 'nextdns_general', url: "https://dns.nextdns.io/dns-query", label: "General" }] }
        ];

        // ControlD専用のプロバイダリスト (H3のみに使用)
        const CONTROLD_PROVIDER = { 
            id: 'controld', 
            name: "ControlD", 
            endpoints: [
                { id: 'control_d_p0', url: "https://freedns.controld.com/p0", label: "Unfiltered" },
                { id: 'control_d_p1', url: "https://freedns.controld.com/p1", label: "Ads & Malware Blocking" },
                { id: 'control_d_p2', url: "https://freedns.controld.com/p2", label: "Ads, Malware & Social Blocking" },
                { id: 'control_d_p3', url: "https://freedns.controld.com/p3", label: "Full Blocking" },
                { id: 'control_d_family', url: "https://freedns.controld.com/family", label: "Family Protection" },
                { id: 'control_d_uncensored', url: "https://freedns.controld.com/uncensored", label: "Uncensored" }
            ] 
        };

        // プロトコルごとの設定
        const PROTOCOL_CONFIGS = [
            { 
                protocolId: 'h2', 
                protocolName: 'DoH/HTTP/2 (TCP/TLS)',
                descriptionJa: '標準的なDoH (HTTP/2) の接続テストです。',
                descriptionEn: 'Standard DoH (HTTP/2) connection test over TCP/TLS.',
                color: 'blue-600',
                // H2にはControlDを含めない
                providers: BASE_PROVIDERS 
            },
            { 
                protocolId: 'h3', 
                protocolName: 'DoH/HTTP/3 (QUIC)',
                // 文字列リテラル内でHTMLタグを使用し、`undefined`を防ぐ
                descriptionJa: 'HTTP/3 (QUIC) プロトコルを使用したDoH接続テストです。<strong class="font-bold text-gray-800">成功はブラウザとサーバー間のH3ネゴシエーションに依存します。</strong>',
                descriptionEn: 'DoH connection test using HTTP/3 (QUIC) protocol. <strong class="font-bold text-gray-800">Success depends on H3 negotiation between the browser and server.</strong>',
                color: 'purple-600',
                // H3には全てのプロバイダを含める (ControlDを含む)
                providers: [...BASE_PROVIDERS, CONTROLD_PROVIDER]
            }
        ];
        
        // UIでレンダリングおよびステータス管理に使用する全てのテストグループのリスト
        let DOH_TEST_GROUPS = [];

        // テストに使用するドメインとクエリタイプ
        const TEST_DOMAIN = 'example.com'; 
        const QUERY_TYPES = {
            ipv4: { name: 'A', text: 'IPv4接続' },
            ipv6: { name: 'AAAA', text: 'IPv6接続' }
        };

        // DoHテストのステータスを追跡するためのグローバル変数 (一意なグループIDがキー)
        let dohTestStatuses = {}; 
        
        document.addEventListener('DOMContentLoaded', () => {
            const runAllDohTestButton = document.getElementById('runAllDohTest');
            const resultsContainer = document.getElementById('testResultsContainer');
            const langButtons = document.querySelectorAll('.lang-btn');
            const toggleDetailsButton = document.getElementById('toggleDetailsButton');
            const dns53TextEl = document.getElementById('dns53Text');
            const dotTextEl = document.getElementById('dotText');

            // グループ化された全てのテスト設定を生成
            function generateTestGroups() {
                DOH_TEST_GROUPS = PROTOCOL_CONFIGS.flatMap(pConfig => {
                    return pConfig.providers.map(bProvider => { // ここでpConfig.providersを使用
                        return {
                            ...bProvider, // id, name, endpoints
                            protocolId: pConfig.protocolId,
                            protocolName: pConfig.protocolName,
                            protocolColor: pConfig.color,
                            groupId: `${bProvider.id}_${pConfig.protocolId}`, // 一意なID
                            protocolDescriptionJa: pConfig.descriptionJa,
                            protocolDescriptionEn: pConfig.descriptionEn,
                        };
                    });
                });
            }

            // 初期化時にステータスオブジェクトを構築
            function initializeStatuses() {
                dohTestStatuses = DOH_TEST_GROUPS.reduce((acc, group) => {
                    acc[group.groupId] = {
                        result: 'pending', // 'pending', 'testing', 'success', 'failure', 'partial' (グループ内全体)
                        endpointStatuses: group.endpoints.reduce((eAcc, ep) => {
                            eAcc[ep.id] = { 
                                ipv4Status: { result: 'pending', duration: null, status: null, error: null },
                                ipv6Status: { result: 'pending', duration: null, status: null, error: null },
                            };
                            return eAcc;
                        }, {})
                    };
                    return acc;
                }, {});
            }
            
            // UIテキストを現在の言語に更新する関数
            function updateUI(lang) {
                const text = LANGUAGES[lang];
                document.getElementById('appTitle').textContent = text.appTitle;
                document.getElementById('mainTitle').textContent = text.mainTitle;
                
                // HTMLコンテンツを含むためinnerHTMLを使用
                document.getElementById('descriptionText').innerHTML = text.descriptionText;
                
                document.getElementById('dohTitle').innerHTML = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c6.83-2.924 10.75-2.924 12 0a11.955 11.955 0 01-11.618 17.06c-1.573.189-3.155.289-4.755.289-4.721 0-8.665-1.921-12-5.187m2.382-7.854l4.004 4.004m0 0l4.004-4.004"></path></svg>${text.dohTitle}`;
                
                // HTMLコンテンツを含むためinnerHTMLを使用
                document.getElementById('dohDescription').innerHTML = text.dohDescription;
                runAllDohTestButton.textContent = text.runAllButton;
                
                document.getElementById('otherDnsTitle').innerHTML = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${text.otherDnsTitle}`;
                
                // strongタグを含むためinnerHTMLを使用
                dns53TextEl.innerHTML = `<strong class="font-bold">${text.dns53Title}</strong> ${text.dns53Content}`;
                dotTextEl.innerHTML = `<strong class="font-bold">${text.dotTitle}</strong> ${text.dotContent}`;
                document.getElementById('hintTitle').textContent = text.hintTitle;
                document.getElementById('hintContent').textContent = text.hintContent;
                document.getElementById('footerText').textContent = text.footerText;

                langButtons.forEach(button => {
                    if (button.dataset.lang === lang) {
                        button.classList.remove('bg-gray-200', 'text-gray-700');
                        button.classList.add('bg-blue-100', 'text-blue-800', 'font-semibold');
                    } else {
                        button.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                        button.classList.add('bg-gray-200', 'text-gray-700');
                    }
                });
                
                // UI再描画とサマリー更新
                initializeResults(); 
                updateSummary(); 
            }

            // プロトコルごとにグループ化されたHTMLを生成
            function initializeResults() {
                const text = LANGUAGES[currentLang];
                resultsContainer.innerHTML = ''; // 初期化

                PROTOCOL_CONFIGS.forEach(pConfig => {
                    // グループ内のプロトコル説明を取得
                    const protocolDescription = currentLang === 'ja' ? pConfig.descriptionJa : pConfig.descriptionEn;

                    const protocolGroups = DOH_TEST_GROUPS.filter(g => g.protocolId === pConfig.protocolId);
                    
                    // プロトコルセクションヘッダー
                    const headerClass = pConfig.protocolId === 'h3' ? 'text-purple-600 border-purple-600' : 'text-blue-600 border-blue-600';
                    const headerHtml = `
                        <div class="border-b ${headerClass} pb-2 mb-4">
                            <h3 class="text-xl font-bold ${pConfig.protocolId === 'h3' ? 'text-purple-800' : 'text-blue-800'}">${pConfig.protocolName}</h3>
                            <p class="text-sm text-gray-600 mt-1">${protocolDescription}</p>
                        </div>
                    `;
                    resultsContainer.insertAdjacentHTML('beforeend', headerHtml);


                    // プロバイダカードの生成
                    const cardsHtml = protocolGroups.map(group => {
                        const groupStatus = dohTestStatuses[group.groupId];
                        const status = groupStatus.result;
                        
                        let statusClass = 'pending';
                        let statusText = text.status.pending;
                        let detailColor = 'border-gray-200';
                        
                        if (status === 'testing') {
                            statusClass = 'pending flex items-center';
                            statusText = `<span class="loading-spinner mr-2"></span>${text.status.groupStatusTesting}`;
                            detailColor = 'border-yellow-300';
                        } else if (status === 'success') {
                            statusClass = 'success';
                            statusText = text.status.available;
                            detailColor = 'border-green-300';
                        } else if (status === 'partial') {
                            statusClass = 'partial'; 
                            statusText = text.status.groupStatusPartial;
                            detailColor = 'border-yellow-300';
                        } else if (status === 'failure') {
                            statusClass = 'failure';
                            statusText = text.status.unavailable;
                            detailColor = 'border-red-300';
                        }

                        // エンドポイントの詳細リスト (detailsVisibleの状態に応じて表示/非表示を決定)
                        const endpointDetailsHtml = group.endpoints.map(ep => {
                            const epStatus = dohTestStatuses[group.groupId].endpointStatuses[ep.id];
                            return generateEndpointDetailsHtml(ep, epStatus, text);
                        }).join('');

                        // グループごとのカード。detailsVisibleがfalseの場合、hiddenクラスが適用される
                        return `
                            <div id="result-group-${group.groupId}" class="p-3 border rounded-lg bg-white ${detailColor}">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-bold text-lg text-gray-800">${group.name}</span>
                                    <div class="flex items-center space-x-2">
                                        <span id="group-status-${group.groupId}" class="test-status ${statusClass}">${statusText}</span>
                                        <button id="run-group-${group.groupId}" class="group-test-btn">
                                            ${text.status.runSingle}
                                        </button>
                                    </div>
                                </div>
                                <!-- 詳細セクション。detailsVisibleの状態をHTML生成時に適用 -->
                                <div id="endpoint-details-${group.groupId}" class="mt-3 p-2 bg-gray-50 rounded-md ${detailsVisible ? '' : 'hidden'}">
                                    <p class="font-semibold text-sm text-gray-800 mb-1">エンドポイント詳細:</p>
                                    ${endpointDetailsHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                    resultsContainer.insertAdjacentHTML('beforeend', `<div class="space-y-3">${cardsHtml}</div>`);
                });

                // 個別グループテストボタンにイベントリスナーを設定
                DOH_TEST_GROUPS.forEach(group => {
                    const singleRunButton = document.getElementById(`run-group-${group.groupId}`);
                    if (singleRunButton) {
                        singleRunButton.addEventListener('click', () => runGroupedTest(group.groupId));
                    }
                });
            }

            // エンドポイントの詳細HTMLを生成するヘルパー関数
            function generateEndpointDetailsHtml(endpoint, epStatus, text) {
                if (!epStatus) epStatus = { ipv4Status: { result: 'pending' }, ipv6Status: { result: 'pending' } };

                // IPv4/IPv6のステータス表示を生成
                function generateIpStatus(type, status) {
                    let statusClass = 'pending';
                    let statusText = text.status.pending;
                    
                    if (status.result === 'testing') {
                        statusClass = 'partial';
                        statusText = text.status.endpointTesting(text.status.connectionType[type]);
                    } else if (status.result === 'success') {
                        statusClass = 'success';
                        statusText = text.status.endpointSuccess(status.duration, status.status);
                    } else if (status.result === 'failure') {
                        statusClass = 'failure';
                        
                        // 失敗原因に基づいたテキストを生成
                        if (status.error === 'Network Error') {
                            statusText = text.status.endpointErrorNetwork(status.duration || 'N/A');
                        } else if (status.error === 'HTTP Error') {
                            statusText = text.status.endpointErrorHttp(status.status, status.duration || 'N/A');
                        } else if (status.error === 'Invalid DNS Response') {
                            statusText = text.status.endpointErrorInvalidDns(status.status, status.duration || 'N/A');
                        } else {
                            // その他のエラー (念のため)
                            statusText = text.status.endpointErrorNetwork(status.duration || 'N/A');
                        }
                    }

                    return `
                        <div class="flex items-start mt-1">
                            <span class="text-xs font-semibold w-24 flex-shrink-0">${text.status.connectionType[type]}:</span>
                            <span class="test-status ${statusClass} text-xs ml-2 break-all flex-grow-0">${statusText}</span>
                        </div>
                    `;
                }

                const ipv4Html = generateIpStatus('ipv4', epStatus.ipv4Status);
                const ipv6Html = generateIpStatus('ipv6', epStatus.ipv6Status);

                return `
                    <div id="endpoint-detail-${endpoint.id}" class="mt-3 p-3 bg-white border border-gray-200 rounded-md">
                        <p class="font-bold text-sm text-gray-800 mb-2">${endpoint.label} (${endpoint.url})</p>
                        ${ipv4Html}
                        ${ipv6Html}
                    </div>
                `;
            }

            
            /**
             * 特定のIPクエリタイプ(ipv4/ipv6)でのテストを実行し、その結果を返します。
             */
            async function testDohConnectivity(endpoint, queryType, groupId, endpointId) {
                const typeName = QUERY_TYPES[queryType].name;
                const fullUrl = `${endpoint.url}?name=${TEST_DOMAIN}&type=${typeName}`;
                
                const epStatusKey = `${queryType}Status`;
                const startTime = performance.now();
                
                // テスト中の状態を即座に反映
                dohTestStatuses[groupId].endpointStatuses[endpointId][epStatusKey].result = 'testing';
                // この時点ではグループ全体のUI更新は行わず、個別の詳細のみを更新
                updateEndpointDetails(groupId); 

                try {
                    // Note: fetch() will automatically attempt HTTP/3 negotiation if the browser and server support it.
                    const response = await fetch(fullUrl, { 
                        method: 'GET',
                        cache: 'no-store',
                        credentials: 'omit'
                    });
                    
                    const duration = (performance.now() - startTime).toFixed(2);
                    
                    if (response.ok) {
                        try {
                            const json = await response.json();
                            
                            // DNS応答の検証 (Statusフィールドの有無)
                            if (json && typeof json.Status === 'number') {
                                return { result: 'success', duration, status: json.Status, error: null };
                            } else {
                                // HTTP OKだがDNS応答として不正
                                return { result: 'failure', duration, status: response.status, error: 'Invalid DNS Response' };
                            }
                        } catch (jsonError) {
                             // JSON解析エラーが発生した場合
                            return { result: 'failure', duration, status: response.status, error: 'Invalid DNS Response' };
                        }
                    } else {
                        // 4xx, 5xxなどのHTTPエラー
                        return { result: 'failure', duration, status: response.status, error: 'HTTP Error' };
                    }

                } catch (error) {
                    // ネットワークレベルのエラー (Failed to fetchなど)
                    const duration = (performance.now() - startTime).toFixed(2);
                    return { result: 'failure', duration, status: null, error: 'Network Error' };
                }
            }
            
            /**
             * プロバイダグループ内の全てのテストを並列実行し、グループステータスを更新します。
             */
            async function runGroupedTest(groupId) {
                const group = DOH_TEST_GROUPS.find(g => g.groupId === groupId);
                if (!group) return;

                const text = LANGUAGES[currentLang];
                const groupButton = document.getElementById(`run-group-${groupId}`);
                const groupStatusEl = document.getElementById(`group-status-${groupId}`);
                const groupCardEl = document.getElementById(`result-group-${groupId}`);

                // 状態を「テスト中」に設定
                dohTestStatuses[groupId].result = 'testing';
                
                // UIを更新
                if (groupButton) groupButton.disabled = true;
                runAllDohTestButton.disabled = true;
                groupStatusEl.innerHTML = `<span class="loading-spinner mr-2"></span>${text.status.groupStatusTesting}`;
                groupStatusEl.className = 'test-status pending flex items-center';
                groupCardEl.classList.remove('border-green-300', 'border-red-300', 'border-gray-200');
                groupCardEl.classList.add('border-yellow-300');
                updateSummary(); // テスト中としてサマリーを更新
                
                // エンドポイントの詳細表示を強制的に更新（テスト中の表示を反映させるため）
                updateEndpointDetails(groupId);


                // 全てのエンドポイントでIPv4/IPv6テストを並列で実行
                const testPromises = group.endpoints.flatMap(ep => [
                    testDohConnectivity(ep, 'ipv4', groupId, ep.id).then(res => ({ id: ep.id, type: 'ipv4', status: res })),
                    testDohConnectivity(ep, 'ipv6', groupId, ep.id).then(res => ({ id: ep.id, type: 'ipv6', status: res }))
                ]);
                
                const results = await Promise.all(testPromises);

                // 結果をグローバルステータスに統合
                let allTestsSuccess = true;
                let anySuccess = false;
                let totalTests = 0;
                
                // Groupのテストが完了したことをマーク
                
                results.forEach(res => {
                    const epStatus = dohTestStatuses[groupId].endpointStatuses[res.id];
                    const statusKey = `${res.type}Status`;
                    epStatus[statusKey] = res.status;
                    totalTests++;

                    if (res.status.result === 'success') {
                        anySuccess = true;
                    } else {
                        allTestsSuccess = false;
                    }
                });

                // グループの最終ステータスを決定
                let finalGroupResult;
                if (allTestsSuccess && totalTests > 0) {
                    finalGroupResult = 'success';
                } else if (anySuccess) {
                    finalGroupResult = 'partial';
                } else {
                    finalGroupResult = 'failure';
                }
                dohTestStatuses[groupId].result = finalGroupResult;

                // 最終結果でUIを更新
                let statusClass = '';
                let statusText = '';
                let detailColor = '';

                if (finalGroupResult === 'success') {
                    statusClass = 'success';
                    statusText = text.status.available;
                    detailColor = 'border-green-300';
                } else if (finalGroupResult === 'partial') {
                    statusClass = 'partial';
                    statusText = text.status.groupStatusPartial;
                    detailColor = 'border-yellow-300';
                } else { // failure
                    statusClass = 'failure';
                    statusText = text.status.unavailable;
                    detailColor = 'border-red-300';
                }

                groupStatusEl.textContent = statusText;
                groupStatusEl.className = 'test-status ' + statusClass;
                groupCardEl.classList.remove('border-yellow-300');
                groupCardEl.classList.add(detailColor);
                if (groupButton) groupButton.disabled = false;
                
                // 最終結果でサマリーと詳細表示を更新
                updateSummary();
                updateEndpointDetails(groupId); 

                // 全体テストの実行中でなければ、全体テストボタンを有効化
                const isAnyGroupTesting = DOH_TEST_GROUPS.some(g => dohTestStatuses[g.groupId].result === 'testing');
                if (!isAnyGroupTesting) {
                    runAllDohTestButton.disabled = false;
                }
            }
            
            /**
             * 全てのDoHテストを順番に実行します。
             */
            async function runAllDohTests() {
                runAllDohTestButton.disabled = true;
                const totalGroups = DOH_TEST_GROUPS.length;
                
                for (let i = 0; i < totalGroups; i++) {
                    const groupId = DOH_TEST_GROUPS[i].groupId;
                    await runGroupedTest(groupId);
                }
                
                runAllDohTestButton.disabled = false;
            }


            /**
             * エンドポイントの詳細表示を最新のステータスで更新します。
             */
            function updateEndpointDetails(groupId) {
                const group = DOH_TEST_GROUPS.find(g => g.groupId === groupId);
                const groupStatus = dohTestStatuses[groupId];
                const text = LANGUAGES[currentLang];
                const detailsContainer = document.getElementById(`endpoint-details-${groupId}`);

                if (!group || !detailsContainer) return;
                
                // エンドポイントの詳細HTMLを再生成
                const endpointDetailsHtml = group.endpoints.map(ep => {
                    const epStatus = groupStatus.endpointStatuses[ep.id];
                    return generateEndpointDetailsHtml(ep, epStatus, text);
                }).join('');

                detailsContainer.innerHTML = `<p class="font-semibold text-sm text-gray-800 mb-1">エンドポイント詳細:</p>${endpointDetailsHtml}`;
                
                // 現在のdetailsVisibleの状態に応じて、表示/非表示を強制的に再適用し、状態を維持する
                // detailsVisibleの状態を、要素がレンダリングされた後で適用する
                if (detailsVisible) {
                    detailsContainer.classList.remove('hidden');
                } else {
                    detailsContainer.classList.add('hidden');
                }
            }

            
            /**
             * テストサマリーセクションとトグルボタンを更新します。
             */
            function updateSummary() {
                const counts = { pending: 0, testing: 0, success: 0, failure: 0, partial: 0 };
                const text = LANGUAGES[currentLang];
                
                Object.values(dohTestStatuses).forEach(status => {
                    if (status.result === 'success') {
                        counts.success++;
                    } else if (status.result === 'failure') {
                        counts.failure++;
                    } else if (status.result === 'partial') {
                        counts.partial++;
                    } else if (status.result === 'testing') {
                        counts.testing++;
                    } else if (status.result === 'pending') {
                        counts.pending++;
                    }
                });

                const total = DOH_TEST_GROUPS.length;
                const completed = counts.success + counts.failure + counts.partial;
                
                // 概要表示を更新
                const summaryHtml = `
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-gray-700">${completed} / ${total}</span>
                        <span class="text-xs text-gray-500">${currentLang === 'ja' ? '完了' : 'Completed'}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-green-600">${counts.success}</span>
                        <span class="text-xs text-green-600">${currentLang === 'ja' ? '完全成功' : 'Full Success'}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-yellow-600">${counts.partial}</span>
                        <span class="text-xs text-yellow-600">${currentLang === 'ja' ? '一部成功' : 'Partial'}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-red-600">${counts.failure}</span>
                        <span class="text-xs text-red-600">${currentLang === 'ja' ? '失敗' : 'Failed'}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-gray-400">${counts.pending + counts.testing}</span>
                        <span class="text-xs text-gray-400">${currentLang === 'ja' ? '未完了' : 'Pending'}</span>
                    </div>
                `;
                document.getElementById('statusSummary').innerHTML = summaryHtml;
                
                // トグルボタンを更新
                let buttonText;
                let icon;

                if (detailsVisible) {
                    buttonText = `${text.status.hideDetails} (${completed} / ${total})`;
                    icon = `<svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`;
                } else {
                    buttonText = `${text.status.showDetails} (${completed} / ${total})`;
                    icon = `<svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                }
                toggleDetailsButton.innerHTML = `${icon}${buttonText}`;
            }
            
            /**
             * 詳細リストの表示・非表示を切り替えます。
             */
            function toggleDetails() {
                // 状態を反転させる
                detailsVisible = !detailsVisible;

                DOH_TEST_GROUPS.forEach(group => {
                    const detailsEl = document.getElementById(`endpoint-details-${group.groupId}`);
                    if (detailsEl) {
                        // detailsVisibleがtrueならhiddenを削除（表示）
                        // detailsVisibleがfalseならhiddenを追加（非表示）
                        detailsEl.classList.toggle('hidden', !detailsVisible);
                    }
                });
                
                updateSummary(); // ボタンテキストを更新するために呼び出し
            }


            // イベントリスナー設定
            langButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newLang = button.dataset.lang;
                    if (newLang !== currentLang) {
                        currentLang = newLang;
                        // 設定データとステータスを再初期化してUIを更新
                        generateTestGroups();
                        initializeStatuses();
                        updateUI(currentLang);
                    }
                });
            });

            // トグルボタンは、クリック時に各プロバイダの詳細表示を一斉に切り替える
            toggleDetailsButton.addEventListener('click', toggleDetails);

            runAllDohTestButton.addEventListener('click', runAllDohTests);

            // 初期化
            generateTestGroups();
            initializeStatuses();
            updateUI(currentLang);
        });
    </script>
</body>
</html>
