<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">DNS制限テスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Tailwind gray-100 */
        }
        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem; /* rounded-lg */
            font-weight: 600;
            display: inline-block;
            font-size: 0.875rem; /* text-sm */
        }
        .success {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
        }
        .failure {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
        }
        .pending {
            background-color: #fef3c7; /* Tailwind yellow-100 */
            color: #92400e; /* Tailwind yellow-800 */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* グループテストボタンのスタイル */
        .group-test-btn {
            @apply px-4 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-300;
        }
        .group-test-btn:disabled {
            @apply bg-gray-400 text-gray-700 cursor-not-allowed shadow-none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        <!-- Language Switcher -->
        <div class="flex justify-end mb-4">
            <button id="lang-ja" class="lang-btn px-3 py-1 text-sm rounded-lg bg-blue-100 text-blue-800 font-semibold mr-2" data-lang="ja">日本語</button>
            <button id="lang-en" class="lang-btn px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-700" data-lang="en">English</button>
        </div>
        
        <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4 border-b-2 pb-2">
            DNS制限テストツール
        </h1>
        <p id="descriptionText" class="text-gray-600 mb-8">
            お使いのネットワーク（大学のLANなど）で、各種DNS解決方法が利用可能かテストします。
        </p>

        <!-- DoH Test Section -->
        <section class="mb-8 border border-gray-200 rounded-lg p-4 bg-blue-50">
            <h2 id="dohTitle" class="text-2xl font-semibold text-blue-800 mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c6.83-2.924 10.75-2.924 12 0a11.955 11.955 0 01-11.618 17.06c-1.573.189-3.155.289-4.755.289-4.721 0-8.665-1.921-12-5.187m2.382-7.854l4.004 4.004m0 0l4.004-4.004"></path></svg>
                DNS over HTTPS (DoH) テスト (複数プロバイダ)
            </h2>
            <p id="dohDescription" class="text-gray-700 mb-4">
                ブラウザの標準的なHTTPS通信(ポート443)を利用して、外部DoHサーバーに接続できるかをテストします。
                プロバイダ名が緑色になれば、そのプロバイダの少なくとも1つのエンドポイントが利用可能です。
            </p>
            
            <button id="runAllDohTest" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 active:bg-blue-800 mb-4">
                全テスト実行
            </button>

            <!-- Summary and Toggle Section -->
            <div id="summarySection" class="mb-4 p-4 bg-white border border-gray-200 rounded-lg shadow-md">
                <div id="statusSummary" class="flex justify-around text-center mb-3 space-x-2">
                    <!-- Status counts will go here (Updated by JS) -->
                </div>
                <button id="toggleDetailsButton" class="w-full py-2 text-sm font-semibold rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-150">
                    <!-- Text updated by JS -->
                </button>
            </div>


            <!-- Test Results Area -->
            <div id="testResultsContainer" class="mt-4 space-y-3">
                <!-- 結果がJavaScriptによってここに挿入される -->
            </div>
            
        </section>

        <!-- Other DNS Methods Explanation -->
        <section class="mb-8 p-4 border border-gray-200 rounded-lg bg-yellow-50">
            <h2 id="otherDnsTitle" class="text-2xl font-semibold text-yellow-800 mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                その他のDNS制限について
            </h2>
            
            <div class="space-y-4 text-gray-700">
                <p id="dns53Text">
                    <strong class="font-bold">通常のDNS (ポート53):</strong>
                    ブラウザから直接テストすることはできませんが、外部DNSを設定した機器で名前解決を試すことで確認できます。
                </p>
                <p id="dotText">
                    <strong class="font-bold">DNS over TLS (DoT - ポート853):</strong>
                    ブラウザのセキュリティ制限により、Webページから直接接続可否をテストすることは技術的に不可能です。
                </p>
                <p class="p-3 bg-white border border-yellow-200 rounded-md">
                    <strong id="hintTitle" class="text-yellow-700">【ヒント】</strong>
                    <span id="hintContent">ポート53/853の制限を確認したい場合は、PCやスマートフォンでVPNサービスやカスタムDNS設定を有効にし、ウェブサイトが正常に表示されるか（名前解決ができるか）を確認するのが最も確実な方法です。</span>
                </p>
            </div>
        </section>

        <footer class="text-center mt-8 pt-4 border-t border-gray-200">
            <p id="footerText" class="text-sm text-gray-500">
                これはクライアント側のJavaScriptテストであり、ネットワークの完全な状態を示すものではありません。
            </p>
        </footer>
    </div>

    <script type="text/javascript">
        // 言語設定の定数
        const LANGUAGES = {
            ja: {
                appTitle: "DNS制限テストツール",
                mainTitle: "DNS制限テストツール",
                descriptionText: "お使いのネットワーク（大学のLANなど）で、各種DNS解決方法が利用可能かテストします。",
                dohTitle: "DNS over HTTPS (DoH) テスト (複数プロバイダ)",
                dohDescription: "ブラウザの標準的なHTTPS通信(ポート443)を利用して、外部DoHサーバーに接続できるかをテストします。プロバイダ名が緑色になれば、そのプロバイダの少なくとも1つのエンドポイントが利用可能です。",
                runAllButton: "全テスト実行",
                otherDnsTitle: "その他のDNS制限について",
                dns53Title: "通常のDNS (ポート53):",
                dns53Content: "ブラウザから直接テストすることはできませんが、外部DNSを設定した機器で名前解決を試すことで確認できます。",
                dotTitle: "DNS over TLS (DoT - ポート853):",
                dotContent: "ブラウザのセキュリティ制限により、Webページから直接接続可否をテストすることは技術的に不可能です。",
                hintTitle: "【ヒント】",
                hintContent: "ポート53/853の制限を確認したい場合は、PCやスマートフォンでVPNサービスやカスタムDNS設定を有効にし、ウェブサイトが正常に表示されるか（名前解決ができるか）を確認するのが最も確実な方法です。",
                footerText: "これはクライアント側のJavaScriptテストであり、ネットワークの完全な状態を示すものではありません。",
                status: {
                    pending: "未実行",
                    testing: "テスト中...",
                    available: "利用可能",
                    unavailable: "利用不可",
                    runSingle: "テスト実行",
                    showDetails: "詳細を表示",
                    hideDetails: "詳細を非表示",
                    groupStatusPartial: "一部利用可能",
                    groupStatusTesting: "グループテスト中...",
                    endpointTesting: "外部DoHサーバーにHTTPSリクエストを送信中...",
                    endpointSuccess: (duration, status) => `接続成功。レスポンスタイム: ${duration}ms。DNS応答ステータス: ${status}`,
                    endpointErrorHttp: (status) => `サーバーに到達しましたが、HTTPエラーが発生しました。ステータス: ${status}`,
                    endpointErrorDns: (status) => `応答あり（${status}）ですが、DNSデータとして認識できませんでした。`,
                    endpointErrorNetwork: (error, duration) => `接続失敗（ネットワークエラー）。DoH通信がブロックされている可能性が高いです。エラー: ${error}。時間: ${duration}ms。`
                }
            },
            en: {
                appTitle: "DNS Restriction Test Tool",
                mainTitle: "DNS Restriction Test Tool",
                descriptionText: "Test whether various DNS resolution methods are available on your network (e.g., university LAN).",
                dohTitle: "DNS over HTTPS (DoH) Test (Multiple Providers)",
                dohDescription: "Tests connectivity to external DoH servers using standard HTTPS (Port 443). If the provider name is green, at least one endpoint of that provider is available.",
                runAllButton: "Run All Tests",
                otherDnsTitle: "About Other DNS Restrictions",
                dns53Title: "Traditional DNS (Port 53):",
                dns53Content: "Cannot be tested directly from the browser, but can be checked by trying name resolution on a device configured with external DNS.",
                dotTitle: "DNS over TLS (DoT - Port 853):",
                dotContent: "Directly testing connectivity from a webpage is technically impossible due to browser security restrictions.",
                hintTitle: "【Hint】",
                hintContent: "To check restrictions on ports 53/853, the surest method is to enable a VPN service or custom DNS settings on your PC or smartphone and verify if websites load correctly (if name resolution works).",
                footerText: "This is a client-side JavaScript test and does not represent the full state of the network.",
                status: {
                    pending: "Pending",
                    testing: "Connecting...",
                    available: "Available",
                    unavailable: "Unavailable",
                    runSingle: "Run Test",
                    showDetails: "Show Details",
                    hideDetails: "Hide Details",
                    groupStatusPartial: "Partially Available",
                    groupStatusTesting: "Group Testing...",
                    endpointTesting: "Sending DoH query...",
                    endpointSuccess: (duration, status) => `Connection successful. Response time: ${duration}ms. DNS response status: ${status}`,
                    endpointErrorHttp: (status) => `Server reached, but HTTP error occurred. Status: ${status}`,
                    endpointErrorDns: (status) => `Response received (${status}), but not recognized as DNS data.`,
                    endpointErrorNetwork: (error, duration) => `Connection failed (Network Error). DoH communication is likely blocked. Error: ${error}. Time: ${duration}ms.`
                }
            }
        };

        let currentLang = 'ja';

        // DoHテストに使用するプロバイダグループのリスト
        const DOH_PROVIDERS = [
            {
                id: 'google',
                name: "Google Public DNS",
                endpoints: [{ id: 'google_default', url: "https://dns.google/resolve?name=example.com&type=A", label: "Default" }]
            },
            {
                id: 'cloudflare',
                name: "Cloudflare DNS",
                endpoints: [{ id: 'cloudflare_default', url: "https://cloudflare-dns.com/dns-query?name=example.com&type=A", label: "Default" }]
            },
            {
                id: 'quad9',
                name: "Quad9 DNS",
                endpoints: [{ id: 'quad9_default', url: "https://dns.quad9.net/dns-query?name=example.com&type=A", label: "Default" }]
            },
            {
                id: 'adguard',
                name: "AdGuard DNS",
                endpoints: [
                    { id: 'adguard_default', url: "https://dns.adguard.com/dns-query?name=example.com&type=A", label: "Default" },
                    { id: 'adguard_family', url: "https://dns-family.adguard.com/dns-query?name=example.com&type=A", label: "Family Protection" }
                ]
            },
            {
                id: 'cleanbrowsing',
                name: "CleanBrowsing",
                endpoints: [{ id: 'cleanbrowsing_family', url: "https://doh.cleanbrowsing.org/doh/family/?name=example.com&type=A", label: "Family" }]
            },
            {
                id: 'nextdns',
                name: "NextDNS",
                endpoints: [{ id: 'nextdns_general', url: "https://dns.nextdns.io/dns-query?name=example.com&type=A", label: "General" }]
            },
            {
                id: 'controld',
                name: "ControlD",
                endpoints: [{ id: 'control_d_default', url: "https://freedns.controld.com/p1?name=example.com&type=A", label: "Default" }]
            }
        ];
        
        // DoHテストのステータスを追跡するためのグローバル変数 (グループIDがキー)
        let dohTestStatuses = {}; 

        document.addEventListener('DOMContentLoaded', () => {
            const runAllDohTestButton = document.getElementById('runAllDohTest');
            const resultsContainer = document.getElementById('testResultsContainer');
            const langButtons = document.querySelectorAll('.lang-btn');
            const toggleDetailsButton = document.getElementById('toggleDetailsButton');

            // 初期化時にステータスオブジェクトを構築
            function initializeStatuses() {
                dohTestStatuses = DOH_PROVIDERS.reduce((acc, group) => {
                    acc[group.id] = {
                        result: 'pending', // 'pending', 'testing', 'success', 'failure', 'partial'
                        endpointStatuses: group.endpoints.reduce((eAcc, ep) => {
                            eAcc[ep.id] = { result: 'pending', duration: null, status: null, error: null };
                            return eAcc;
                        }, {})
                    };
                    return acc;
                }, {});
            }
            
            // UIテキストを現在の言語に更新する関数
            function updateUI(lang) {
                const text = LANGUAGES[lang];
                document.getElementById('appTitle').textContent = text.appTitle;
                document.getElementById('mainTitle').textContent = text.mainTitle;
                document.getElementById('descriptionText').textContent = text.descriptionText;
                
                // SVGを含むdohTitleの更新
                document.getElementById('dohTitle').innerHTML = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c6.83-2.924 10.75-2.924 12 0a11.955 11.955 0 01-11.618 17.06c-1.573.189-3.155.289-4.755.289-4.721 0-8.665-1.921-12-5.187m2.382-7.854l4.004 4.004m0 0l4.004-4.004"></path></svg>${text.dohTitle}`;
                document.getElementById('dohDescription').textContent = text.dohDescription;
                runAllDohTestButton.textContent = text.runAllButton;
                
                // SVGを含むotherDnsTitleの更新
                document.getElementById('otherDnsTitle').innerHTML = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${text.otherDnsTitle}`;
                
                document.getElementById('dns53Text').innerHTML = `<strong class="font-bold">${text.dns53Title}</strong> ${text.dns53Content}`;
                document.getElementById('dotText').innerHTML = `<strong class="font-bold">${text.dotTitle}</strong> ${text.dotContent}`;
                document.getElementById('hintTitle').textContent = text.hintTitle;
                document.getElementById('hintContent').textContent = text.hintContent;
                document.getElementById('footerText').textContent = text.footerText;

                // 言語ボタンのアクティブ状態を更新
                langButtons.forEach(button => {
                    if (button.dataset.lang === lang) {
                        button.classList.remove('bg-gray-200', 'text-gray-700');
                        button.classList.add('bg-blue-100', 'text-blue-800', 'font-semibold');
                    } else {
                        button.classList.remove('bg-blue-100', 'text-blue-800', 'font-semibold');
                        button.classList.add('bg-gray-200', 'text-gray-700');
                    }
                });
                
                // 結果表示エリアを再初期化して、新しい言語のテキストを反映させる
                initializeResults();
                updateSummary(); // サマリーテキストも更新
            }

            // グループ化された初期表示用のHTMLを生成
            function initializeResults() {
                const text = LANGUAGES[currentLang];
                resultsContainer.innerHTML = DOH_PROVIDERS.map(group => {
                    const groupStatus = dohTestStatuses[group.id] || { result: 'pending', endpointStatuses: {} };
                    const status = groupStatus.result;
                    
                    let statusClass = 'pending';
                    let statusText = text.status.pending;
                    let detailColor = '';
                    
                    if (status === 'testing') {
                        statusClass = 'pending flex items-center';
                        statusText = `<span class="loading-spinner mr-2"></span>${text.status.groupStatusTesting}`;
                        detailColor = 'border-yellow-300';
                    } else if (status === 'success') {
                        statusClass = 'success';
                        statusText = text.status.available;
                        detailColor = 'border-green-300';
                    } else if (status === 'partial') {
                        statusClass = 'pending'; // Partial is yellow-ish
                        statusText = text.status.groupStatusPartial;
                        detailColor = 'border-yellow-300';
                    } else if (status === 'failure') {
                        statusClass = 'failure';
                        statusText = text.status.unavailable;
                        detailColor = 'border-red-300';
                    }

                    // エンドポイントの詳細リスト（初期状態では非表示）
                    const endpointDetailsHtml = group.endpoints.map(ep => {
                        const epStatus = groupStatus.endpointStatuses[ep.id] || { result: 'pending', error: null };
                        let epDetailStatusClass = 'text-gray-500';
                        let epDetailStatusText = text.status.pending;
                        
                        if (epStatus.result === 'success') {
                            epDetailStatusClass = 'text-green-600';
                            epDetailStatusText = text.status.endpointSuccess(epStatus.duration, epStatus.status);
                        } else if (epStatus.result === 'failure') {
                            epDetailStatusClass = 'text-red-600';
                            epDetailStatusText = text.status.endpointErrorNetwork(epStatus.error || 'N/A', epStatus.duration);
                        } else if (epStatus.result === 'testing') {
                            epDetailStatusClass = 'text-yellow-600';
                            epDetailStatusText = text.status.endpointTesting;
                        }

                        return `
                            <div class="mt-2 text-xs border-l-2 pl-2 border-gray-300">
                                <span class="font-semibold text-gray-700">${ep.label}:</span>
                                <span class="${epDetailStatusClass} break-all">${epDetailStatusText}</span>
                                <p class="text-gray-500 italic break-all">${ep.url}</p>
                            </div>
                        `;
                    }).join('');

                    // グループごとのカード
                    return `
                        <div id="result-group-${group.id}" class="p-3 border rounded-lg bg-white ${detailColor}">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-lg text-gray-800">${group.name}</span>
                                <div class="flex items-center space-x-2">
                                    <span id="group-status-${group.id}" class="test-status ${statusClass}">${statusText}</span>
                                    <button id="run-group-${group.id}" class="group-test-btn">
                                        ${text.status.runSingle}
                                    </button>
                                </div>
                            </div>
                            <!-- 詳細セクション -->
                            <div id="endpoint-details-${group.id}" class="mt-3 p-2 bg-gray-50 rounded-md hidden">
                                <p class="font-semibold text-sm text-gray-800 mb-1">エンドポイント詳細:</p>
                                ${endpointDetailsHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                // 個別グループテストボタンにイベントリスナーを設定
                DOH_PROVIDERS.forEach(group => {
                    const singleRunButton = document.getElementById(`run-group-${group.id}`);
                    if (singleRunButton) {
                        singleRunButton.addEventListener('click', () => runGroupedTest(group.id));
                    }
                });
            }
            
            /**
             * 特定の単一エンドポイントのテストを実行し、その結果を返します。
             */
            async function testDohEndpoint(endpoint, groupId) {
                const epStatus = { result: 'pending', duration: null, status: null, error: null };
                const startTime = performance.now();
                
                try {
                    const response = await fetch(endpoint.url, { 
                        method: 'GET',
                        cache: 'no-store',
                        credentials: 'omit'
                    });
                    
                    epStatus.duration = (performance.now() - startTime).toFixed(2);

                    if (response.ok) {
                        const json = await response.json();
                        
                        // DNS応答の検証
                        if (json && typeof json.Status === 'number') {
                            epStatus.result = 'success'; 
                            epStatus.status = json.Status;
                        } else {
                            epStatus.result = 'failure';
                            epStatus.status = response.status;
                            epStatus.error = 'Invalid DNS Response Format';
                        }
                    } else {
                        // 4xx, 5xxなどのHTTPエラー
                        epStatus.result = 'failure';
                        epStatus.status = response.status;
                        epStatus.error = 'HTTP Error';
                    }

                } catch (error) {
                    // ネットワークレベルのエラー
                    epStatus.duration = (performance.now() - startTime).toFixed(2);
                    epStatus.result = 'failure';
                    epStatus.error = error.message;
                }

                // グローバルステータスオブジェクトを更新
                dohTestStatuses[groupId].endpointStatuses[endpoint.id] = epStatus;
                return epStatus;
            }

            /**
             * プロバイダグループ内の全てのテストを並列実行し、グループステータスを更新します。
             */
            async function runGroupedTest(groupId) {
                const group = DOH_PROVIDERS.find(g => g.id === groupId);
                if (!group) return;

                const text = LANGUAGES[currentLang];
                const groupButton = document.getElementById(`run-group-${groupId}`);
                const groupStatusEl = document.getElementById(`group-status-${groupId}`);
                const groupCardEl = document.getElementById(`result-group-${groupId}`);

                // 状態を「テスト中」に設定
                dohTestStatuses[groupId].result = 'testing';
                
                // UIを更新
                if (groupButton) groupButton.disabled = true;
                runAllDohTestButton.disabled = true;
                groupStatusEl.innerHTML = `<span class="loading-spinner mr-2"></span>${text.status.groupStatusTesting}`;
                groupStatusEl.className = 'test-status pending flex items-center';
                groupCardEl.classList.remove('border-green-300', 'border-red-300');
                groupCardEl.classList.add('border-yellow-300');
                updateSummary();
                
                // エンドポイントの詳細表示を強制的に更新（テスト中の表示を反映させるため）
                updateEndpointDetails(groupId);


                // 全てのエンドポイントテストを並列で実行
                const testPromises = group.endpoints.map(ep => testDohEndpoint(ep, groupId));
                const results = await Promise.all(testPromises);

                // グループの最終ステータスを決定
                const successCount = results.filter(r => r.result === 'success').length;
                const totalCount = results.length;

                if (successCount === totalCount) {
                    dohTestStatuses[groupId].result = 'success';
                } else if (successCount > 0) {
                    dohTestStatuses[groupId].result = 'partial';
                } else {
                    dohTestStatuses[groupId].result = 'failure';
                }

                // 最終結果でUIを更新
                const finalStatus = dohTestStatuses[groupId].result;
                let statusClass = '';
                let statusText = '';
                let detailColor = '';

                if (finalStatus === 'success') {
                    statusClass = 'success';
                    statusText = text.status.available;
                    detailColor = 'border-green-300';
                } else if (finalStatus === 'partial') {
                    statusClass = 'pending';
                    statusText = text.status.groupStatusPartial;
                    detailColor = 'border-yellow-300';
                } else { // failure
                    statusClass = 'failure';
                    statusText = text.status.unavailable;
                    detailColor = 'border-red-300';
                }

                groupStatusEl.textContent = statusText;
                groupStatusEl.className = 'test-status ' + statusClass;
                groupCardEl.classList.remove('border-yellow-300');
                groupCardEl.classList.add(detailColor);
                if (groupButton) groupButton.disabled = false;
                
                updateEndpointDetails(groupId); // 詳細表示を最終結果で更新
                updateSummary();
                
                // 全体テストの実行中でなければ、全体テストボタンを有効化
                if (!document.querySelector('.loading-spinner')) {
                    runAllDohTestButton.disabled = false;
                }
            }
            
            /**
             * 全てのプロバイダグループのテストを順番に実行します。
             */
            async function runAllDohTests() {
                runAllDohTestButton.disabled = true;
                
                // 全ての個別ボタンを無効化
                document.querySelectorAll('.group-test-btn').forEach(btn => btn.disabled = true);
                
                // 結果表示を初期化
                initializeResults();

                for (const group of DOH_PROVIDERS) {
                    await runGroupedTest(group.id);
                }

                runAllDohTestButton.disabled = false;
                
                // 全ての個別ボタンを有効化
                document.querySelectorAll('.group-test-btn').forEach(btn => btn.disabled = false);
            }

            /**
             * エンドポイントの詳細表示を最新のステータスで更新します。
             */
            function updateEndpointDetails(groupId) {
                const group = DOH_PROVIDERS.find(g => g.id === groupId);
                const groupStatus = dohTestStatuses[groupId];
                const text = LANGUAGES[currentLang];
                const detailsContainer = document.getElementById(`endpoint-details-${groupId}`);

                if (!group || !detailsContainer) return;

                const endpointDetailsHtml = group.endpoints.map(ep => {
                    const epStatus = groupStatus.endpointStatuses[ep.id] || { result: 'pending', error: null };
                    let epDetailStatusClass = 'text-gray-500';
                    let epDetailStatusText = text.status.pending;
                    
                    if (epStatus.result === 'testing') {
                        epDetailStatusClass = 'text-yellow-600 flex items-center';
                        epDetailStatusText = `<span class="loading-spinner mr-2"></span>${text.status.endpointTesting}`;
                    } else if (epStatus.result === 'success') {
                        epDetailStatusClass = 'text-green-600';
                        epDetailStatusText = text.status.endpointSuccess(epStatus.duration, epStatus.status);
                    } else if (epStatus.result === 'failure') {
                        epDetailStatusClass = 'text-red-600';
                        const error = epStatus.error || 'Network Error/Blocked';
                        epDetailStatusText = text.status.endpointErrorNetwork(error, epStatus.duration || 'N/A');
                    }

                    return `
                        <div class="mt-2 text-xs border-l-2 pl-2 border-gray-300">
                            <span class="font-semibold text-gray-700">${ep.label}:</span>
                            <span class="${epDetailStatusClass} break-all">${epDetailStatusText}</span>
                            <p class="text-gray-500 italic break-all">${ep.url}</p>
                        </div>
                    `;
                }).join('');

                detailsContainer.innerHTML = `<p class="font-semibold text-sm text-gray-800 mb-1">エンドポイント詳細:</p>${endpointDetailsHtml}`;
            }

            
            /**
             * テストサマリーセクションを更新します。
             */
            function updateSummary() {
                const counts = { pending: 0, success: 0, failure: 0, partial: 0 };
                const text = LANGUAGES[currentLang];
                
                Object.values(dohTestStatuses).forEach(status => {
                    if (status.result === 'success') {
                        counts.success++;
                    } else if (status.result === 'failure') {
                        counts.failure++;
                    } else if (status.result === 'partial') {
                        counts.partial++;
                    } else if (status.result === 'pending' || status.result === 'testing') {
                        counts.pending++;
                    }
                });

                const total = DOH_PROVIDERS.length;
                const completed = counts.success + counts.failure + counts.partial;
                
                // 概要表示を更新
                const summaryHtml = `
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-gray-700">${completed} / ${total}</span>
                        <span class="text-xs text-gray-500">完了</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-green-600">${counts.success}</span>
                        <span class="text-xs text-green-600">成功</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-yellow-600">${counts.partial}</span>
                        <span class="text-xs text-yellow-600">一部成功</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-red-600">${counts.failure}</span>
                        <span class="text-xs text-red-600">失敗</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-sm font-bold text-gray-400">${counts.pending}</span>
                        <span class="text-xs text-gray-400">未実行</span>
                    </div>
                `;
                document.getElementById('statusSummary').innerHTML = summaryHtml;
                
                // トグルボタンを更新
                const isHidden = resultsContainer.classList.contains('hidden');
                
                let buttonText;
                if (isHidden) {
                    buttonText = `${text.status.showDetails} (${completed} / ${total})`;
                    toggleDetailsButton.innerHTML = `<svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>${buttonText}`;
                } else {
                    buttonText = `${text.status.hideDetails} (${completed} / ${total})`;
                    toggleDetailsButton.innerHTML = `<svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>${buttonText}`;
                }
            }
            
            /**
             * 詳細リストの表示・非表示を切り替えます。
             */
            function toggleDetails() {
                resultsContainer.classList.toggle('hidden');
                
                // 表示/非表示が切り替わったときに、詳細セクションの表示も連動させる
                const isHidden = resultsContainer.classList.contains('hidden');
                DOH_PROVIDERS.forEach(group => {
                    const detailsEl = document.getElementById(`endpoint-details-${group.id}`);
                    if (detailsEl) {
                        // 全体が非表示なら詳細も非表示に
                        if (isHidden) {
                            detailsEl.classList.add('hidden');
                        } else {
                            // 全体が表示なら、詳細セクションを再表示（デフォルトでは非表示）
                            detailsEl.classList.remove('hidden');
                        }
                    }
                });
                
                updateSummary(); // ボタンテキストを更新するために呼び出し
            }
            
            // 初期の詳細リストは表示状態にし、エンドポイントの詳細パネルを非表示にする
            function initialToggleSetup() {
                resultsContainer.classList.remove('hidden'); // 詳細リストコンテナは最初から表示

                // 各プロバイダの詳細パネルは隠しておく
                DOH_PROVIDERS.forEach(group => {
                    const detailsEl = document.getElementById(`endpoint-details-${group.id}`);
                    if (detailsEl) {
                        detailsEl.classList.add('hidden');
                    }
                });
            }


            // イベントリスナー設定
            langButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newLang = button.dataset.lang;
                    if (newLang !== currentLang) {
                        currentLang = newLang;
                        updateUI(currentLang);
                    }
                });
            });

            // トグルボタンは、クリック時に各プロバイダの詳細表示も連動して切り替えます
            toggleDetailsButton.addEventListener('click', () => {
                const isHidden = resultsContainer.classList.contains('hidden');
                
                DOH_PROVIDERS.forEach(group => {
                    const detailsEl = document.getElementById(`endpoint-details-${group.id}`);
                    if (detailsEl) {
                         if (!isHidden) {
                            // 全体を非表示にする前に、個々の詳細を非表示にする
                            detailsEl.classList.add('hidden');
                        } else {
                            // 全体を表示する前に、個々の詳細を表示にする
                            detailsEl.classList.remove('hidden');
                        }
                    }
                });
                
                toggleDetails(); // 全体の表示/非表示を切り替える
            });

            runAllDohTestButton.addEventListener('click', runAllDohTests);

            // 初期化
            initializeStatuses();
            updateUI(currentLang);
            initialToggleSetup(); // UI初期設定を再実行
        });
    </script>
</body>
</html>
